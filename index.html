<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Service - โรงพยาบาลอุดรธานี</title>
    
    <script>
        const userSession = localStorage.getItem('session');
        if (!userSession) {
            window.location.replace('login.html');
        }
    </script>

    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="loader-content">
            <div class="spinner"></div>
            <p>กำลังประมวลผล...</p>
        </div>
    </div>

    <nav>
        <div class="nav-container">
            <div class="brand">
                <img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" alt="LOGO" class="logo">
                <span class="brand-text">IT MAINTENANCE</span>
            </div>
            <div class="user-info">
                <span id="staffName"></span>
                <button onclick="localStorage.clear(); window.location.replace('login.html');" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2>ลงทะเบียนรับงาน / สร้างใบงาน</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>ประเภทงาน:</label>
                    <select id="jobType">
                        <option value="คอมพิวเตอร์">คอมพิวเตอร์</option>
                        <option value="เครือข่าย">เครือข่าย</option>
                        <option value="ซอฟต์แวร์">ซอฟต์แวร์</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ครุภัณฑ์ (Asset ID):</label>
                    <select id="assetID"><option value="">-- เลือกครุภัณฑ์ --</option></select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>เลขที่บันทึกข้อความ:</label>
                    <input type="text" id="docNumber" placeholder="ระบุเลขที่บันทึก (ถ้ามี)">
                </div>
                <div class="form-group">
                    <label>ผู้มอบหมาย:</label>
                    <input type="text" id="assignBy" placeholder="ระบุชื่อผู้มอบหมาย">
                </div>
            </div>

            <div class="form-group">
                <label>รายละเอียดงาน:</label>
                <textarea id="detail" rows="3" placeholder="ระบุรายละเอียด..."></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>แนบบันทึกข้อความ (PDF/รูป):</label>
                    <input type="file" id="docFile" accept=".pdf,image/*">
                </div>
                <div class="form-group">
                    <label>ถ่ายรูปงานซ่อม:</label>
                    <input type="file" id="repairPhoto" accept="image/*" capture="camera">
                </div>
            </div>

            <button id="btnSubmit" onclick="submitJob()" class="btn-primary">บันทึกข้อมูลและเปิดใบงาน</button>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ทำงานเมื่อหน้าเว็บโหลดเสร็จสมบูรณ์
        window.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('session'));
            if (user) {
                document.getElementById('staffName').innerText = "ผู้ใช้งาน: " + user.name;
                
                // โหลด Master Data ครั้งเดียว
                try {
                    const assets = await apiRequest({action: 'getAssets'}, 'GET');
                    const select = document.getElementById('assetID');
                    if (assets && select) {
                        assets.forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a.assetID;
                            opt.text = `${a.assetID} - ${a.name}`;
                            select.appendChild(opt);
                        });
                    }
                } catch (e) {
                    console.log("Error loading assets");
                }
            }
        });
    </script>
</body>
</html>
