<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบสำรวจครุภัณฑ์คอมพิวเตอร์</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Kanit', sans-serif; background:#fff0f3; }
    .card { border-radius:16px; }
    .hidden { display:none; }
  </style>
</head>
<body>

<div class="container mt-5">

  <div class="text-center mb-4">
    <img src="https://img2.pic.in.th/pic/ink.png" width="60"><br>
    <h4>ระบบสำรวจครุภัณฑ์คอมพิวเตอร์</h4>
    <p>โรงพยาบาลอุดรธานี</p>
  </div>

  <!-- REGISTER -->
  <div id="section-reg" class="card p-4 mx-auto" style="max-width:420px">
    <h5 class="text-center mb-3">ลงทะเบียนเข้าใช้งาน</h5>

    <input id="reg-email" class="form-control mb-2" placeholder="Email">
    <input id="reg-name" class="form-control mb-2" placeholder="ชื่อ - สกุล">
    <input list="depts" id="reg-dept" class="form-control mb-3" placeholder="หน่วยงาน">
    <datalist id="depts"></datalist>

    <button class="btn btn-primary w-100" onclick="register()">เข้าใช้งาน</button>
  </div>

  <!-- SURVEY -->
  <div id="section-survey" class="hidden mt-4">
    <div class="card p-4">
      <h5 id="user-dept"></h5>
      <p>แบบสำรวจครุภัณฑ์ (ตัวอย่าง)</p>
      <button class="btn btn-success" onclick="showReport()">ดูรายงาน</button>
    </div>
  </div>

  <!-- REPORT -->
  <div id="section-report" class="hidden mt-4">
    <div class="card p-4">
      <h5>รายงานการสำรวจ</h5>
      <p>หน่วยงาน: <span id="r-dept"></span></p>
      <p>ผู้รายงาน: <span id="r-name"></span></p>

      <table class="table table-bordered">
        <tr>
          <th>รหัส</th><th>รายการ</th><th>สถานะ</th>
        </tr>
        <tr>
          <td>COM-001</td><td>คอมพิวเตอร์</td><td>ปกติ</td>
        </tr>
      </table>

      <button class="btn btn-secondary" onclick="location.reload()">กลับหน้าแรก</button>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";

let userData = {};
let confirmedData = [];

/* =============== JSONP =============== */
function callAPI(p, cb){
  const c="cb_"+Date.now(); p.callback=c;
  window[c]=(r)=>{delete window[c];document.body.removeChild(s);cb(r);}
  const s=document.createElement("script");
  s.src=API_URL+"?"+new URLSearchParams(p);
  document.body.appendChild(s);
}

/* =============== LOAD DEPT =============== */
window.onload=()=>{
  callAPI({action:"departments"},res=>{
    const dl=document.getElementById("depts");
    res.data.forEach(d=>dl.innerHTML+=`<option value="${d.name}">`);
  });
};

/* =============== LOGIN =============== */
function register(){
  userData={
    email:reg-email.value,
    name:reg-name.value,
    dept:reg-dept.value
  };
  if(!userData.email||!userData.name||!userData.dept)
    return Swal.fire("กรอกข้อมูลให้ครบ");

  section-reg.classList.add("hidden");
  section-survey.classList.remove("hidden");
  user-dept-display.innerText="หน่วยงาน: "+userData.dept;
}

/* =============== SEARCH =============== */
function searchAsset(){
  callAPI({action:"searchAssets",query:asset-query.value},res=>{
    const box=search-results; box.innerHTML="";
    res.data.forEach(i=>{
      box.innerHTML+=`
      <div class="asset-card">
        <b>${i.assetId}</b><br>${i.name}
        <button class="btn btn-cute btn-sm"
          onclick='addAsset(${JSON.stringify(i)})'>เลือก</button>
      </div>`;
    });
  });
}

/* =============== ADD =============== */
function addAsset(i){
  if(confirmedData.find(x=>x.assetId===i.assetId))
    return Swal.fire("เลือกแล้ว");
  confirmedData.push(i);
  confirmed-list.classList.remove("hidden");
  survey-items.innerHTML=confirmedData.map(x=>x.assetId).join(", ");
}

/* =============== SUBMIT =============== */
function submitSurvey(){
  let done=0;
  confirmedData.forEach(i=>{
    callAPI({action:"saveSurvey",data:JSON.stringify({...i,deptName:userData.dept})},()=>{
      if(++done===confirmedData.length) showReport();
    });
  });
}

/* =============== REPORT =============== */
function showReport(){
  document.querySelector(".no-print").classList.add("hidden");
  section-report.classList.add("print-only");
  report-dept.innerText=userData.dept;
  report-user.innerText=userData.name;
  report-date.innerText=new Date().toLocaleDateString("th-TH");
  report-table-body.innerHTML=confirmedData.map(x=>`
    <tr><td>${x.assetId}</td><td>${x.name}</td><td>ปกติ</td></tr>
  `).join("");
  window.print();
}
</script>


</body>
</html>
