<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{background:#8b004f;color:#fff;padding:10px}
.card{background:#fff;margin:10px;padding:15px;border-radius:8px}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.btn{background:#8b004f;color:#fff}
.top{background:#fff2f7}
</style>
</head>

<body>

<header>
  <b id="itInfo"></b>
</header>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>IT Login</h3>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button class="btn" onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none">

  <!-- WORKING JOB -->
  <div class="card top">
    <h3>üîß ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
    <div id="workingList"></div>
  </div>

  <!-- ALL JOB -->
  <div class="card">
    <h3>üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <div id="ticketList"></div>
  </div>

  <!-- APP LINK -->
  <div class="card">
    <h3>üîó ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô</h3>
    <button onclick="openApp('ASSET')">Asset App</button>
    <button onclick="openApp('SERVICE')">Service App</button>
  </div>

</div>

<script>
let IT=null;

// ---------- LOGIN ----------
function login(){
  google.script.run.withSuccessHandler(res=>{
    if(res.status==='success'){
      IT=res.it;
      localStorage.setItem('it',JSON.stringify(IT));
      showDashboard();
    }else alert('Login failed');
  }).itLogin(
    email.value,password.value
  );
}

function showDashboard(){
  loginBox.style.display='none';
  dashboard.style.display='block';
  itInfo.innerText = IT.name + ' | ' + IT.position;
  loadWorking();
  loadTickets();
}

// ---------- WORKING ----------
function loadWorking(){
  google.script.run.withSuccessHandler(data=>{
    let html='';
    if(data.length===0) html='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô';
    data.forEach(r=>{
      html+=`
        <div class="card">
          <b>${r[0]}</b><br>
          ${r[6]}<br>
          <button onclick="closeJob('${r[0]}')">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
        </div>`;
    });
    workingList.innerHTML=html;
  }).getMyWorkingJobs(IT.id);
}

// ---------- ALL ----------
function loadTickets(){
  google.script.run.withSuccessHandler(data=>{
    let html='';
    data.forEach(r=>{
      html+=`
        <div class="card">
          <b>${r[0]}</b><br>
          ${r[6]}<br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r[8]}<br>
          <button onclick="assign('${r[0]}')">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
        </div>`;
    });
    ticketList.innerHTML=html;
  }).getTickets();
}

// ---------- ACTION ----------
function assign(id){
  google.script.run.withSuccessHandler(()=>{
    loadWorking();loadTickets();
  }).assignTicket(id,IT.id);
}

function closeJob(id){
  google.script.run.withSuccessHandler(()=>{
    loadWorking();loadTickets();
  }).closeTicket(id);
}

// ---------- LINK APP ----------
function openApp(app){
  const base={
    ASSET:'https://asset-app-url',
    SERVICE:'https://service-app-url'
  };
  window.open(`${base[app]}?it=${IT.id}`,'_blank');
}

// auto login
window.onload=()=>{
  const s=localStorage.getItem('it');
  if(s){IT=JSON.parse(s);showDashboard();}
}
</script>

</body>
</html>
